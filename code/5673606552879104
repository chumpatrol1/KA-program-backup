// Given a wavelength in nm return a reasonably accurate colour
// Colours will also depend on your monitor

// From http://www.designingwithleds.com/light-spectrum-charts-data/
// 360 - 760nm
var data = {
    // From http://rredc.nrel.gov/solar/spectra/am1.5/
    'Daylight': [
        0.266,0.237,0.258,0.275,0.281,0.306,0.346,0.338,0.315,0.342,0.343,0.339,0.317,0.284,0.269,0.302,0.327,0.369,0.415,0.348,0.359,0.361,0.273,0.224,0.282,0.332,0.320,0.328,0.322,0.369,0.409,0.440,0.375,0.222,0.305,0.433,0.340,0.275,0.486,0.569,0.585,0.611,0.637,0.615,0.626,0.612,0.599,0.589,0.617,0.660,0.564,0.633,0.674,0.648,0.642,0.666,0.687,0.672,0.644,0.672,0.617,0.702,0.693,0.673,0.670,0.692,0.674,0.652,0.659,0.612,0.489,0.445,0.741,0.690,0.639,0.702,0.771,0.788,0.693,0.667,0.766,0.757,0.811,0.824,0.804,0.836,0.750,0.854,0.866,0.865,0.898,0.932,0.894,0.826,0.887,0.882,0.912,0.921,0.902,0.896,0.891,0.924,0.933,0.938,0.910,0.899,0.919,0.879,0.918,0.923,0.889,0.904,0.952,0.916,0.927,0.959,0.927,0.933,0.965,0.947,0.964,0.964,0.969,0.958,0.940,0.938,0.761,0.853,0.924,0.871,0.974,0.936,0.893,0.956,0.934,0.992,0.944,0.961,0.935,0.936,0.933,0.905,0.905,0.948,0.884,0.948,0.986,0.944,0.921,0.965,0.941,0.959,0.984,0.925,0.906,0.933,0.942,0.768,0.879,0.852,0.930,0.938,0.959,0.904,0.973,0.966,0.939,0.822,0.941,0.986,0.948,1.000,0.982,0.877,0.940,0.955,0.996,0.922,0.968,0.945,0.913,0.878,0.956,0.940,0.974,0.952,0.943,0.956,0.929,0.958,0.951,0.951,0.970,0.943,0.962,0.968,0.951,0.928,0.949,0.898,0.914,0.968,0.922,0.957,0.939,0.945,0.894,0.953,0.945,0.922,0.923,0.893,0.943,0.948,0.943,0.922,0.914,0.938,0.909,0.922,0.938,0.942,0.957,0.967,0.965,0.957,0.935,0.955,0.934,0.807,0.858,0.918,0.899,0.912,0.908,0.897,0.924,0.927,0.916,0.916,0.925,0.915,0.901,0.920,0.937,0.935,0.931,0.936,0.933,0.926,0.923,0.918,0.932,0.919,0.891,0.924,0.899,0.888,0.922,0.926,0.927,0.931,0.898,0.892,0.889,0.883,0.882,0.908,0.859,0.889,0.877,0.892,0.859,0.914,0.900,0.911,0.890,0.920,0.926,0.923,0.903,0.904,0.906,0.915,0.911,0.918,0.892,0.888,0.880,0.853,0.857,0.911,0.875,0.903,0.893,0.852,0.748,0.782,0.874,0.877,0.883,0.879,0.872,0.874,0.881,0.897,0.896,0.890,0.893,0.908,0.896,0.894,0.882,0.889,0.888,0.881,0.891,0.883,0.888,0.880,0.882,0.878,0.882,0.873,0.867,0.868,0.848,0.615,0.711,0.715,0.749,0.781,0.803,0.798,0.789,0.804,0.802,0.847,0.834,0.817,0.811,0.801,0.802,0.806,0.827,0.836,0.831,0.828,0.825,0.828,0.833,0.832,0.826,0.817,0.824,0.796,0.805,0.703,0.654,0.587,0.627,0.690,0.786,0.726,0.671,0.660,0.687,0.690,0.662,0.666,0.717,0.681,0.733,0.760,0.785,0.774,0.766,0.765,0.779,0.757,0.775,0.772,0.773,0.789,0.795,0.795,0.793,0.794,0.789,0.787,0.786,0.782,0.785,0.781,0.791,0.789,0.780,0.779,0.784,0.762,0.172],
    // Incandescent 60W bulb
    'Incandescent': [0,0,0,0,0,0,0.001,0.001,0.002,0.003,0.004,0.004,0.005,0.006,0.007,0.008,0.009,0.01,0.012,0.013,0.014,0.015,0.016,0.017,0.017,0.018,0.019,0.02,0.021,0.022,0.023,0.024,0.025,0.026,0.027,0.028,0.029,0.03,0.031,0.032,0.034,0.036,0.037,0.038,0.039,0.041,0.042,0.043,0.044,0.045,0.046,0.048,0.05,0.053,0.055,0.057,0.058,0.059,0.061,0.062,0.063,0.064,0.065,0.067,0.069,0.071,0.072,0.074,0.075,0.076,0.078,0.079,0.08,0.082,0.084,0.086,0.087,0.089,0.09,0.092,0.094,0.096,0.098,0.1,0.102,0.104,0.106,0.108,0.111,0.113,0.115,0.116,0.118,0.119,0.121,0.123,0.125,0.126,0.128,0.13,0.132,0.135,0.137,0.138,0.14,0.142,0.144,0.146,0.149,0.152,0.154,0.156,0.157,0.159,0.161,0.164,0.166,0.169,0.171,0.173,0.175,0.178,0.18,0.183,0.185,0.188,0.19,0.193,0.194,0.196,0.198,0.201,0.204,0.206,0.208,0.21,0.213,0.215,0.218,0.22,0.222,0.224,0.226,0.229,0.231,0.232,0.235,0.238,0.241,0.244,0.246,0.248,0.25,0.253,0.255,0.259,0.262,0.265,0.268,0.27,0.273,0.275,0.278,0.281,0.284,0.286,0.289,0.292,0.296,0.298,0.3,0.303,0.307,0.31,0.312,0.315,0.318,0.32,0.325,0.328,0.331,0.334,0.337,0.339,0.342,0.345,0.347,0.351,0.354,0.358,0.361,0.364,0.367,0.37,0.374,0.377,0.38,0.383,0.386,0.39,0.394,0.397,0.4,0.404,0.407,0.41,0.413,0.416,0.419,0.423,0.426,0.429,0.432,0.438,0.441,0.443,0.446,0.449,0.452,0.455,0.459,0.463,0.467,0.47,0.473,0.477,0.479,0.482,0.485,0.489,0.492,0.496,0.499,0.502,0.506,0.508,0.511,0.516,0.519,0.522,0.525,0.528,0.534,0.537,0.541,0.543,0.546,0.551,0.553,0.556,0.559,0.563,0.566,0.57,0.574,0.576,0.579,0.582,0.585,0.59,0.594,0.597,0.601,0.604,0.61,0.612,0.614,0.618,0.621,0.625,0.629,0.633,0.636,0.639,0.644,0.648,0.652,0.655,0.658,0.661,0.665,0.669,0.674,0.677,0.679,0.683,0.686,0.693,0.696,0.699,0.702,0.704,0.71,0.714,0.718,0.72,0.722,0.728,0.731,0.734,0.739,0.742,0.744,0.747,0.75,0.755,0.757,0.758,0.761,0.763,0.77,0.773,0.776,0.779,0.781,0.782,0.786,0.79,0.796,0.799,0.802,0.806,0.806,0.806,0.808,0.811,0.816,0.819,0.821,0.825,0.827,0.83,0.835,0.836,0.837,0.841,0.845,0.849,0.851,0.852,0.858,0.861,0.863,0.869,0.871,0.873,0.878,0.881,0.884,0.885,0.883,0.888,0.89,0.892,0.896,0.898,0.9,0.908,0.909,0.909,0.912,0.914,0.917,0.919,0.922,0.925,0.929,0.93,0.931,0.941,0.941,0.94,0.944,0.945,0.947,0.956,0.959,0.952,0.958,0.962,0.965,0.97,0.973,0.967,0.974,0.975,0.976,0.98,0.982,0.983,0.987,0.991,0.984,0.989,0.99,0.989,0.997,1,0.998,0.996,0.997
],
    // T12 fluorescent lamp: 2900K
    'Fluorescent': [
        0.006,0.006,0.006,0.005,0.005,0.005,0.006,0.006,0.006,0.006,0.006,0.005,0.005,0.005,0.005,0.005,0.005,0.005,0.006,0.006,0.006,0.006,0.005,0.005,0.005,0.005,0.004,0.005,0.005,0.005,0.006,0.006,0.006,0.005,0.005,0.005,0.005,0.006,0.013,0.02,0.025,0.03,0.031,0.032,0.033,0.033,0.032,0.031,0.029,0.024,0.019,0.015,0.011,0.01,0.01,0.01,0.01,0.011,0.012,0.013,0.013,0.014,0.015,0.016,0.018,0.02,0.022,0.025,0.034,0.043,0.219,0.262,0.306,0.308,0.31,0.311,0.308,0.306,0.304,0.291,0.279,0.136,0.093,0.05,0.048,0.046,0.046,0.045,0.045,0.045,0.044,0.044,0.042,0.041,0.04,0.039,0.038,0.037,0.036,0.035,0.034,0.032,0.031,0.03,0.03,0.029,0.028,0.027,0.027,0.026,0.026,0.025,0.024,0.024,0.024,0.026,0.028,0.034,0.039,0.052,0.064,0.103,0.124,0.145,0.165,0.184,0.199,0.215,0.222,0.229,0.224,0.215,0.205,0.19,0.175,0.159,0.143,0.127,0.112,0.084,0.073,0.061,0.052,0.042,0.036,0.029,0.025,0.021,0.017,0.016,0.015,0.015,0.015,0.014,0.014,0.013,0.013,0.013,0.013,0.012,0.012,0.012,0.012,0.011,0.012,0.013,0.014,0.017,0.021,0.026,0.03,0.047,0.066,0.084,0.122,0.16,0.236,0.312,0.515,0.611,0.707,0.77,0.834,0.857,0.881,0.888,0.873,0.779,0.694,0.609,0.516,0.422,0.349,0.275,0.188,0.158,0.127,0.104,0.081,0.05,0.043,0.036,0.032,0.028,0.027,0.025,0.024,0.025,0.025,0.029,0.033,0.041,0.049,0.074,0.09,0.107,0.127,0.147,0.169,0.191,0.233,0.256,0.278,0.293,0.307,0.316,0.316,0.316,0.313,0.309,0.282,0.267,0.252,0.237,0.221,0.21,0.199,0.178,0.171,0.163,0.165,0.167,0.205,0.26,0.314,0.429,0.544,0.766,0.834,0.902,0.941,0.979,0.99,1,0.956,0.893,0.829,0.726,0.622,0.452,0.402,0.353,0.326,0.299,0.274,0.269,0.264,0.255,0.246,0.22,0.206,0.193,0.18,0.166,0.137,0.122,0.106,0.091,0.076,0.057,0.053,0.05,0.048,0.049,0.05,0.054,0.057,0.061,0.062,0.064,0.064,0.063,0.061,0.06,0.058,0.056,0.054,0.05,0.05,0.049,0.047,0.046,0.046,0.045,0.045,0.044,0.044,0.043,0.041,0.04,0.037,0.036,0.035,0.033,0.033,0.032,0.032,0.032,0.032,0.033,0.034,0.036,0.036,0.037,0.038,0.039,0.04,0.04,0.04,0.041,0.04,0.039,0.037,0.035,0.033,0.032,0.031,0.032,0.034,0.036,0.046,0.053,0.059,0.075,0.084,0.092,0.105,0.109,0.113,0.115,0.111,0.104,0.098,0.092,0.076,0.068,0.06,0.046,0.04,0.034,0.025,0.022,0.019,0.015,0.014,0.014,0.013,0.013,0.012,0.011,0.011,0.011,0.011,0.011,0.011,0.012,0.012,0.012,0.013,0.013,0.013,0.013,0.013,0.013,0.014,0.014,0.014,0.014,0.013,0.012,0.012,0.012,0.012,0.011,0.012,0.012,0.013,0.012,0.012,0.012,0.012],
    // Cree LED TW series T8; 4000K version
    'Cool white LED': [0.021,0.022,0.02,0.02,0.021,0.021,0.02,0.021,0.022,0.021,0.021,0.021,0.021,0.02,0.02,0.02,0.02,0.02,0.02,0.02,0.02,0.019,0.019,0.019,0.018,0.018,0.018,0.018,0.019,0.019,0.019,0.02,0.02,0.02,0.02,0.02,0.02,0.019,0.019,0.019,0.019,0.019,0.02,0.02,0.02,0.02,0.021,0.022,0.023,0.024,0.025,0.027,0.029,0.033,0.036,0.04,0.043,0.048,0.052,0.062,0.068,0.074,0.082,0.09,0.099,0.109,0.12,0.131,0.144,0.156,0.183,0.199,0.215,0.235,0.255,0.278,0.301,0.328,0.355,0.389,0.423,0.495,0.541,0.586,0.637,0.688,0.739,0.791,0.838,0.885,0.919,0.952,0.976,0.979,0.973,0.959,0.945,0.918,0.891,0.858,0.825,0.752,0.721,0.69,0.664,0.639,0.616,0.594,0.577,0.56,0.544,0.528,0.487,0.474,0.461,0.452,0.443,0.437,0.43,0.425,0.421,0.416,0.42,0.423,0.428,0.433,0.44,0.447,0.453,0.459,0.471,0.481,0.491,0.5,0.509,0.52,0.531,0.542,0.552,0.568,0.577,0.586,0.596,0.605,0.612,0.619,0.628,0.637,0.65,0.657,0.664,0.67,0.676,0.682,0.688,0.696,0.703,0.71,0.717,0.723,0.727,0.731,0.737,0.743,0.748,0.753,0.758,0.765,0.771,0.775,0.778,0.783,0.789,0.794,0.799,0.804,0.808,0.813,0.818,0.823,0.828,0.834,0.84,0.844,0.847,0.851,0.855,0.858,0.863,0.869,0.872,0.876,0.881,0.886,0.887,0.892,0.896,0.899,0.902,0.905,0.909,0.913,0.916,0.919,0.922,0.926,0.926,0.928,0.93,0.934,0.937,0.939,0.942,0.945,0.947,0.949,0.95,0.952,0.954,0.957,0.957,0.961,0.965,0.967,0.969,0.969,0.97,0.971,0.974,0.976,0.975,0.979,0.982,0.984,0.986,0.986,0.986,0.988,0.99,0.992,0.993,0.995,0.995,0.997,0.999,1,0.997,0.995,0.995,0.994,0.995,0.995,0.996,0.995,0.988,0.986,0.984,0.982,0.981,0.975,0.972,0.97,0.968,0.965,0.957,0.951,0.946,0.942,0.939,0.926,0.922,0.918,0.913,0.907,0.893,0.888,0.883,0.876,0.87,0.853,0.847,0.84,0.826,0.818,0.809,0.802,0.795,0.779,0.772,0.764,0.755,0.746,0.73,0.723,0.715,0.706,0.696,0.68,0.672,0.663,0.646,0.637,0.629,0.621,0.613,0.595,0.586,0.577,0.568,0.559,0.544,0.536,0.529,0.512,0.503,0.494,0.487,0.48,0.465,0.459,0.452,0.436,0.428,0.419,0.412,0.405,0.391,0.384,0.378,0.365,0.358,0.352,0.34,0.333,0.326,0.321,0.315,0.304,0.299,0.293,0.283,0.278,0.273,0.262,0.257,0.253,0.244,0.24,0.236,0.231,0.226,0.218,0.214,0.211,0.203,0.2,0.196,0.191,0.188,0.185,0.179,0.176,0.173,0.166,0.164,0.161,0.156,0.153,0.15,0.147,0.144,0.141,0.137,0.134,0.132,0.129,0.127,0.125,0.123,0.121,0.12,0.117,0.115,0.114,0.111,0.11,0.109,0.107,0.105,0.104,0.101,0.099,0.097,0.094,0.093,0.091,0.09,0.089,0.087,0.086,0.083
    ],
    // Archipelago 6W filament light
    'Warm white LED': [
        0.013,0.013,0.012,0.013,0.013,0.013,0.012,0.012,0.013,0.013,0.013,0.013,0.014,0.013,0.013,0.013,0.013,0.013,0.012,0.012,0.012,0.012,0.012,0.012,0.012,0.012,0.012,0.012,0.012,0.012,0.012,0.012,0.012,0.012,0.012,0.013,0.013,0.013,0.012,0.012,0.012,0.012,0.012,0.012,0.012,0.011,0.011,0.011,0.011,0.011,0.011,0.011,0.011,0.012,0.012,0.012,0.012,0.013,0.013,0.014,0.014,0.014,0.015,0.015,0.016,0.016,0.017,0.018,0.019,0.02,0.021,0.022,0.023,0.025,0.027,0.029,0.031,0.034,0.037,0.041,0.045,0.054,0.06,0.066,0.074,0.081,0.09,0.099,0.108,0.117,0.125,0.134,0.147,0.152,0.157,0.16,0.163,0.164,0.165,0.165,0.164,0.161,0.16,0.159,0.158,0.157,0.157,0.156,0.156,0.157,0.156,0.156,0.15,0.15,0.149,0.148,0.148,0.148,0.148,0.147,0.147,0.147,0.148,0.15,0.152,0.154,0.156,0.158,0.16,0.162,0.166,0.169,0.172,0.175,0.178,0.181,0.185,0.188,0.192,0.197,0.2,0.204,0.207,0.211,0.214,0.217,0.221,0.224,0.231,0.234,0.238,0.241,0.244,0.247,0.25,0.256,0.26,0.263,0.267,0.27,0.273,0.277,0.28,0.284,0.288,0.292,0.295,0.299,0.302,0.305,0.308,0.313,0.317,0.321,0.324,0.327,0.331,0.334,0.34,0.343,0.346,0.351,0.355,0.359,0.362,0.366,0.369,0.375,0.379,0.384,0.388,0.391,0.396,0.4,0.407,0.412,0.416,0.421,0.425,0.432,0.437,0.442,0.447,0.452,0.458,0.463,0.471,0.476,0.481,0.487,0.493,0.499,0.505,0.515,0.521,0.527,0.534,0.54,0.547,0.554,0.565,0.573,0.581,0.588,0.595,0.608,0.616,0.623,0.632,0.641,0.654,0.663,0.672,0.681,0.69,0.698,0.706,0.723,0.732,0.741,0.751,0.76,0.777,0.787,0.797,0.805,0.813,0.829,0.837,0.845,0.854,0.864,0.873,0.881,0.893,0.899,0.906,0.913,0.921,0.933,0.94,0.947,0.953,0.959,0.967,0.97,0.973,0.978,0.982,0.985,0.989,0.993,0.995,0.997,0.997,0.999,1,0.999,0.998,0.993,0.993,0.993,0.988,0.985,0.981,0.978,0.975,0.967,0.964,0.96,0.954,0.948,0.938,0.932,0.927,0.919,0.911,0.899,0.891,0.883,0.868,0.86,0.852,0.845,0.838,0.819,0.81,0.8,0.791,0.782,0.765,0.757,0.749,0.729,0.718,0.707,0.699,0.691,0.673,0.665,0.656,0.637,0.626,0.615,0.606,0.597,0.579,0.569,0.56,0.542,0.534,0.525,0.508,0.499,0.489,0.482,0.475,0.458,0.45,0.442,0.427,0.419,0.412,0.398,0.391,0.384,0.369,0.363,0.356,0.349,0.342,0.33,0.324,0.318,0.306,0.3,0.295,0.286,0.28,0.274,0.264,0.26,0.256,0.245,0.241,0.237,0.229,0.223,0.218,0.212,0.208,0.204,0.196,0.193,0.189,0.183,0.179,0.175,0.169,0.167,0.165,0.161,0.158,0.155,0.15,0.147,0.145,0.14,0.137,0.135,0.131,0.128,0.125,0.122,0.119,0.117,0.115,0.112,0.11,0.108,0.105]
};

// Get names of light for easy reference
var lightTypes = [];
for (var type in data) {
    lightTypes.push(type);
}

// Start at light 1
var index = 0;
var currentType = lightTypes[index];

// Used to save previous light data for transitioning
var oldType;

// If this is > 0 then we are animating
var animation = 0;
var MAX_ANIMATION = 30;

// Convert wavelength to RGB
var wavelengthToColour = function(wavelength) {
    // Black to violet (380 nm - 400 nm)
    if (wavelength < 400) {
        var p = max(0, 255 * (wavelength - 360) / 40);
        return color(p, 0,  p);
    }
    
    // Violet to blue  (400 nm - 450 nm)
    if (wavelength < 450) {
        var p = 255 * (wavelength - 400) / 50;
        return color(255 - p, 0,  255);
    }

    // Blue to cyan (450 nm - 480 nm)
    if (wavelength < 480) {
        var p = 255 * (wavelength - 450) / 30;
        return color(0, p,  255);
    }

    // Cyan to green (480 nm - 540 nm)
    if (wavelength < 540) {
        var p = 255 * (wavelength - 480) / 60;
        return color(0, 255,  255-p);
    }

    // Green to yellow (540 nm - 580 nm)
    if (wavelength < 580) {
        var p = 255 * (wavelength - 540) / 40;
        return color(p, 255, 0);
    }

    // Yellow to red (580 nm - 700 nm)
    if (wavelength < 700) {
        var p = 255 * (wavelength - 580) / 120;
        return color(255, 255-p, 0);
    }

    // Black to red (700 nm - 750 nm)
    if (wavelength < 760) {
        var p = 255 * (wavelength - 700) / 60;
        return color(255-p, 0, 0);
    }

    return color(0, 0, 0);
};

var plotSpectrum = function(source, x, y, h) {
    var spectrum = data[source];
    var oldSpectrum = data[oldType];
    
    var n = spectrum.length;
    var y1 = y + h;
    var wavelength, x1;
    
    background(250);
    
    // Title
    fill(30);
    textSize(24);
    textAlign(CENTER, BASELINE);
    
    // How far through the animation are we
    var p = 1 - animation / MAX_ANIMATION;
    
    // Square it so elements accelerate
    //p = p * p;
    
    var dx = width * p;
    text(source, x + n * 0.5 + width - dx, y - 10);
    if (oldType) {
        text(oldType, x + n * 0.5 - dx, y - 10);
    }

    // Tick marks
    textAlign(RIGHT, CENTER);
    textSize(13);
    strokeWeight(1);
    
    for (var i = 0; i <= 100; i += 20) {
        var y2 = y1 - h * i * 0.01;
        
        // Gridline
        stroke(220);
        line(x, y2, x + n, y2);
        
        // Tick
        stroke(40);
        line(x - 1, y2, x - 6, y2);
        text(i, x - 8, y2);
    }
    
    // Vertical axis
    stroke(40);
    line(x - 1, y, x -1, y1);
    
    // Plot spectrum
    textAlign(CENTER, TOP);
    for (var i = 0; i < n; i++) {
        wavelength = 360 + i;
        x1 = x + i;
        
        var col = wavelengthToColour(wavelength);
        var v = spectrum[i];
        if (oldSpectrum) {
            v = v * p + oldSpectrum[i] * (1 - p);
        }
        v *= h;
        var f = floor(v);
        stroke(col);
        line(x1, y1, x1, y1 - f);
        v -= f;
        
        // Anti-alias
        if (v) {
            stroke(col + (v * 255 << 24));
            point(x1, y1 - f - 1);
        }
        
        // Tick marks
        if (wavelength % 100 === 0) {
            stroke(40);
            line(x1, y1, x1, y1 + 5);
            text(wavelength, x1, y1 + 6);
        }
    }
    
    // Horizontal axis
    stroke(40);
    line(x - 1, y1, x + n, y1);
    
    // Axis labels
    textSize(18);
    text("Wavelength (nm)", x + n * 0.5, y1 + 25);
    
    textAlign(CENTER, BASELINE);
    pushMatrix();
    translate(x - 35, y + h * 0.5);
    rotate(270);
    text("Intensity", 0, 0);
    popMatrix();
};

draw = function() {
    if (animation >= 0) {
        plotSpectrum(currentType, 64, 48, 300);
        animation--;
    }
};

mouseClicked = function() {
    oldType = currentType;
    index = (index + 1) % lightTypes.length;
    currentType = lightTypes[index];
    animation = MAX_ANIMATION;
};
